---
# Quick Check: kube-scheduler Logs
# This playbook quickly checks kube-scheduler logs to diagnose the issue
# Usage: ansible-playbook playbooks/check-scheduler-logs.yml -i inventory-devops.yml

- name: Check kube-scheduler Logs
  hosts: control_plane[0]
  become: true
  gather_facts: false
  
  tasks:
    - name: Get scheduler pod name
      shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get pods -n kube-system -l component=kube-scheduler -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "NO_POD"
      register: scheduler_pod
      changed_when: false
      failed_when: false

    - name: Get scheduler logs
      shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf logs -n kube-system {{ scheduler_pod.stdout }} --tail=50 2>&1 || echo "CANNOT_GET_LOGS"
      register: scheduler_logs
      changed_when: false
      failed_when: false
      when: scheduler_pod.stdout != "NO_POD"

    - name: Display scheduler logs
      debug:
        msg: "{{ scheduler_logs.stdout_lines }}"
      when: scheduler_logs is defined

    - name: Check API server accessibility
      shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get --raw=/healthz 2>&1
      register: api_health
      changed_when: false
      failed_when: false

    - name: Display API server health
      debug:
        msg: "API server health: {{ api_health.stdout }}"

    - name: Check scheduler manifest
      shell: |
        cat /etc/kubernetes/manifests/kube-scheduler.yaml | grep -E '--kubeconfig|--master|server' || echo "No kubeconfig found"
      register: scheduler_manifest
      changed_when: false
      failed_when: false

    - name: Display scheduler manifest config
      debug:
        msg: "{{ scheduler_manifest.stdout_lines }}"

    - name: Check scheduler kubeconfig
      shell: |
        if [ -f /etc/kubernetes/scheduler.conf ]; then
          echo "=== Scheduler kubeconfig server ==="
          grep server /etc/kubernetes/scheduler.conf
        else
          echo "scheduler.conf not found"
        fi
      register: scheduler_kubeconfig
      changed_when: false
      failed_when: false

    - name: Display scheduler kubeconfig
      debug:
        msg: "{{ scheduler_kubeconfig.stdout_lines }}"

    - name: Provide fix instructions
      debug:
        msg: |
          ==========================================
          kube-scheduler Diagnosis
          ==========================================
          
          Common causes:
          1. API server not accessible (most common)
          2. Scheduler kubeconfig pointing to wrong address
          3. API server bind address incorrect
          
          Quick Fix:
          1. Ensure API server is accessible:
             kubectl --kubeconfig=/etc/kubernetes/admin.conf cluster-info
          
          2. If API server is not accessible, fix bind address:
             sudo sed -i 's/--bind-address=127.0.0.1/--bind-address=0.0.0.0/' /etc/kubernetes/manifests/kube-apiserver.yaml
             sudo systemctl restart kubelet
          
          3. Wait for API server, then restart scheduler:
             sleep 30
             kubectl --kubeconfig=/etc/kubernetes/admin.conf delete pod -n kube-system -l component=kube-scheduler
          
          Or run the comprehensive fix:
          ansible-playbook playbooks/fix-control-plane-components.yml -i inventory-devops.yml
          ==========================================

