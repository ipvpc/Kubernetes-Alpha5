---
# Migration Playbook: Switch from Flannel to Calico CNI
# This playbook removes Flannel and installs Calico
# Usage: ansible-playbook playbooks/migrate-to-calico.yml -i inventory-devops.yml

- name: Migrate from Flannel to Calico
  hosts: control_plane[0]
  become: true
  gather_facts: false
  
  vars:
    pod_network_cidr: "{{ pod_network_cidr | default('10.245.0.0/16') }}"
    calico_version: "v3.26.0"
  
  tasks:
    - name: Check if kubeconfig exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_exists

    - name: Check if copied kubeconfig exists
      stat:
        path: /root/.kube/config
      register: kubeconfig_exists

    - name: Set kubeconfig path
      set_fact:
        kubeconfig: "{{ '/etc/kubernetes/admin.conf' if admin_conf_exists.stat.exists else '/root/.kube/config' }}"

    - name: Display kubeconfig being used
      debug:
        msg: "Using kubeconfig: {{ kubeconfig }}"

    - name: Check cluster connectivity
      shell: kubectl --kubeconfig={{ kubeconfig }} cluster-info
      register: cluster_info
      changed_when: false
      failed_when: false

    - name: Fail if cluster not accessible
      fail:
        msg: "Cannot access cluster. Please ensure cluster is initialized and API server is running."
      when: cluster_info.rc != 0

    - name: Check if Flannel is installed
      shell: kubectl --kubeconfig={{ kubeconfig }} get daemonset -n kube-flannel 2>/dev/null | grep -q flannel && echo "installed" || echo "not_installed"
      register: flannel_status
      changed_when: false
      failed_when: false

    - name: Display Flannel status
      debug:
        msg: "Flannel status: {{ flannel_status.stdout }}"

    - name: Check if Calico is already installed
      shell: kubectl --kubeconfig={{ kubeconfig }} get daemonset -n kube-system calico-node 2>/dev/null | grep -q calico-node && echo "installed" || echo "not_installed"
      register: calico_status
      changed_when: false
      failed_when: false

    - name: Display Calico status
      debug:
        msg: "Calico status: {{ calico_status.stdout }}"

    - name: Warn if Calico already installed
      debug:
        msg: "Calico is already installed. No migration needed."
      when: calico_status.stdout == "installed"

    - name: Get current node status
      shell: kubectl --kubeconfig={{ kubeconfig }} get nodes -o wide
      register: node_status
      changed_when: false
      failed_when: false

    - name: Display current node status
      debug:
        msg: "{{ node_status.stdout_lines }}"

    - name: Drain nodes before CNI migration (optional - skip for single node)
      shell: |
        for node in $(kubectl --kubeconfig={{ kubeconfig }} get nodes -o jsonpath='{.items[*].metadata.name}'); do
          kubectl --kubeconfig={{ kubeconfig }} drain $node --ignore-daemonsets --delete-emptydir-data --force --grace-period=30 || true
        done
      when: 
        - flannel_status.stdout == "installed"
        - calico_status.stdout == "not_installed"
      ignore_errors: yes
      changed_when: false

    - name: Delete Flannel if installed
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} delete -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml || true
        # Also try deleting by namespace
        kubectl --kubeconfig={{ kubeconfig }} delete namespace kube-flannel --ignore-not-found=true || true
      when: 
        - flannel_status.stdout == "installed"
        - calico_status.stdout == "not_installed"
      register: flannel_delete
      changed_when: flannel_delete.rc == 0

    - name: Wait for Flannel to be removed
      shell: |
        for i in {1..30}; do
          if ! kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-flannel 2>/dev/null | grep -q flannel; then
            exit 0
          fi
          sleep 2
        done
        exit 1
      register: flannel_removal_wait
      retries: 1
      delay: 0
      until: flannel_removal_wait.rc == 0
      changed_when: false
      ignore_errors: yes
      when: flannel_delete is defined

    - name: Download Calico manifest with custom pod CIDR
      shell: |
        curl -s https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/calico.yaml | \
        sed 's|# - name: CALICO_IPV4POOL_CIDR|            - name: CALICO_IPV4POOL_CIDR|' | \
        sed 's|#   value: "192.168.0.0/16"|              value: "{{ pod_network_cidr }}"|' > /tmp/calico-custom.yaml
      when: calico_status.stdout == "not_installed"
      changed_when: true

    - name: Install Calico with custom pod CIDR
      shell: kubectl --kubeconfig={{ kubeconfig }} apply -f /tmp/calico-custom.yaml
      register: calico_install
      retries: 3
      delay: 10
      until: calico_install.rc == 0
      when: calico_status.stdout == "not_installed"

    - name: Wait for Calico pods to be ready
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod -l k8s-app=calico-node -n kube-system --timeout=300s
      register: calico_wait
      retries: 10
      delay: 10
      until: calico_wait.rc == 0
      changed_when: false
      when: calico_install is defined

    - name: Check Calico installation status
      shell: kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=calico-node -o wide
      register: calico_pods
      changed_when: false
      failed_when: false
      when: calico_install is defined

    - name: Display Calico pods status
      debug:
        msg: "{{ calico_pods.stdout_lines }}"
      when: calico_pods is defined

    - name: Uncordon nodes after migration
      shell: |
        for node in $(kubectl --kubeconfig={{ kubeconfig }} get nodes -o jsonpath='{.items[*].metadata.name}'); do
          kubectl --kubeconfig={{ kubeconfig }} uncordon $node || true
        done
      when: calico_wait.rc == 0 | default(false)
      ignore_errors: yes
      changed_when: false

    - name: Restart kube-proxy after CNI migration
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} delete pod -n kube-system -l k8s-app=kube-proxy
        sleep 10
      when: calico_wait.rc == 0 | default(false)
      ignore_errors: yes

    - name: Wait for kube-proxy to restart
      shell: kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod -l k8s-app=kube-proxy -n kube-system --timeout=180s
      register: kube_proxy_wait
      retries: 6
      delay: 10
      until: kube_proxy_wait.rc == 0
      changed_when: false
      ignore_errors: yes
      when: calico_wait.rc == 0 | default(false)

    - name: Verify cluster status
      shell: kubectl --kubeconfig={{ kubeconfig }} get nodes -o wide
      register: final_node_status
      changed_when: false
      failed_when: false

    - name: Display final cluster status
      debug:
        msg: |
          ==========================================
          Migration to Calico Complete!
          ==========================================
          Node Status:
          {{ final_node_status.stdout }}
          
          Calico Pods:
          {{ calico_pods.stdout | default('Check manually') }}
          
          Verify with:
          kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=calico-node
          kubectl --kubeconfig={{ kubeconfig }} get nodes
          ==========================================
      when: calico_install is defined

    - name: Clean up temporary files
      file:
        path: /tmp/calico-custom.yaml
        state: absent
      when: calico_install is defined

