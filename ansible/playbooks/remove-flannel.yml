---
# Playbook: Remove Flannel CNI Plugin
# This playbook removes Flannel from the cluster
# Usage: ansible-playbook playbooks/remove-flannel.yml -i inventory-devops.yml

- name: Remove Flannel CNI Plugin
  hosts: control_plane[0]
  become: true
  gather_facts: false

  tasks:
    - name: Check if kubeconfig exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_exists

    - name: Check if copied kubeconfig exists
      stat:
        path: /root/.kube/config
      register: copied_kubeconfig_exists

    - name: Set kubeconfig path
      set_fact:
        kubeconfig: "{{ '/etc/kubernetes/admin.conf' if admin_conf_exists.stat.exists else '/root/.kube/config' }}"
      when: admin_conf_exists.stat.exists or copied_kubeconfig_exists.stat.exists

    - name: Check if kubeconfig exists
      stat:
        path: "{{ kubeconfig }}"
      register: kubeconfig_check
      when: admin_conf_exists.stat.exists or copied_kubeconfig_exists.stat.exists

    - name: Check if Flannel is installed
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get daemonset -n kube-flannel kube-flannel-ds 2>/dev/null || echo "Flannel not found"
      register: flannel_check
      changed_when: false
      failed_when: false
      when: kubeconfig_check.stat.exists

    - name: Display Flannel status
      debug:
        msg: "{{ 'Flannel is installed' if 'not found' not in flannel_check.stdout | default('') else 'Flannel is not installed' }}"
      when: flannel_check is defined

    - name: Delete Flannel manifests
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} delete -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml --ignore-not-found
      register: flannel_delete
      changed_when: flannel_delete.rc == 0
      ignore_errors: yes
      when:
        - kubeconfig_check.stat.exists
        - "'not found' not in flannel_check.stdout | default('')"

    - name: Delete kube-flannel namespace
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} delete namespace kube-flannel --ignore-not-found --force --grace-period=0
      register: flannel_ns_delete
      changed_when: flannel_ns_delete.rc == 0
      ignore_errors: yes
      when:
        - kubeconfig_check.stat.exists
        - "'not found' not in flannel_check.stdout | default('')"

    - name: Wait for Flannel pods to terminate
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-flannel --field-selector=status.phase!=Succeeded,status.phase!=Failed --no-headers 2>/dev/null | wc -l || echo "0"
      register: flannel_pods_count
      until: flannel_pods_count.stdout | int == 0
      retries: 10
      delay: 5
      changed_when: false
      when:
        - kubeconfig_check.stat.exists
        - "'not found' not in flannel_check.stdout | default('')"

    - name: Clean up CNI configuration on all nodes
      shell: |
        rm -f /etc/cni/net.d/10-flannel.conflist || true
        rm -f /etc/cni/net.d/kube-flannel.conflist || true
      delegate_to: "{{ item }}"
      loop: "{{ groups['all'] }}"
      changed_when: false
      ignore_errors: yes

    - name: Restart kubelet on all nodes after Flannel removal
      systemd:
        name: kubelet
        state: restarted
      delegate_to: "{{ item }}"
      loop: "{{ groups['all'] }}"
      changed_when: true
      ignore_errors: yes

    - name: Verify Flannel is removed
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get daemonset -n kube-flannel kube-flannel-ds 2>/dev/null || echo "Flannel removed successfully"
      register: flannel_verify
      changed_when: false
      failed_when: false
      when: kubeconfig_check.stat.exists

    - name: Display removal status
      debug:
        msg: |
          ==========================================
          Flannel Removal Summary
          ==========================================
          {% if flannel_verify is defined %}
          Status: {{ 'Flannel removed successfully' if 'removed successfully' in flannel_verify.stdout else 'Check manually' }}
          {% else %}
          Status: Flannel removal attempted
          {% endif %}
          ==========================================
          If Calico is installed, verify it's working:
          kubectl get pods -n kube-system -l k8s-app=calico-node
          ==========================================
      when: kubeconfig_check.stat.exists

