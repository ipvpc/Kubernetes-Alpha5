---
# Diagnostic Playbook: Diagnose and Fix kube-proxy Issues
# Usage: ansible-playbook playbooks/diagnose-kube-proxy.yml -i inventory-devops.yml

- name: Diagnose kube-proxy CrashLoopBackOff
  hosts: control_plane[0]
  become: true
  gather_facts: false
  
  tasks:
    - name: Check if kubeconfig exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_exists

    - name: Check if copied kubeconfig exists
      stat:
        path: /root/.kube/config
      register: kubeconfig_exists

    - name: Set kubeconfig path
      set_fact:
        kubeconfig: "{{ '/etc/kubernetes/admin.conf' if admin_conf_exists.stat.exists else '/root/.kube/config' }}"

    - name: Display kubeconfig being used
      debug:
        msg: "Using kubeconfig: {{ kubeconfig }}"

    - name: Check cluster connectivity
      shell: kubectl --kubeconfig={{ kubeconfig }} cluster-info
      register: cluster_info
      changed_when: false
      failed_when: false

    - name: Display cluster info
      debug:
        msg: "{{ cluster_info.stdout_lines }}"
      when: cluster_info.rc == 0

    - name: Check CNI plugin status
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-flannel -o wide 2>/dev/null || \
        kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=calico-node -o wide 2>/dev/null || \
        echo "CNI not found"
      register: cni_status
      changed_when: false
      failed_when: false

    - name: Display CNI status
      debug:
        msg: "{{ cni_status.stdout_lines }}"

    - name: Check if CNI pods are ready
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-flannel --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l || \
        kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=calico-node --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l || \
        echo "0"
      register: cni_ready_count
      changed_when: false
      failed_when: false

    - name: Display CNI ready count
      debug:
        msg: "CNI pods ready: {{ cni_ready_count.stdout }}"

    - name: Get kube-proxy pod status
      shell: kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=kube-proxy -o wide
      register: kube_proxy_status
      changed_when: false
      failed_when: false

    - name: Display kube-proxy status
      debug:
        msg: "{{ kube_proxy_status.stdout_lines }}"

    - name: Get kube-proxy pod name
      shell: kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=kube-proxy -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo ""
      register: kube_proxy_pod
      changed_when: false
      failed_when: false

    - name: Get kube-proxy logs
      shell: kubectl --kubeconfig={{ kubeconfig }} logs -n kube-system {{ kube_proxy_pod.stdout }} --tail=50 2>&1 || echo "Could not get logs"
      register: kube_proxy_logs
      changed_when: false
      failed_when: false
      when: kube_proxy_pod.stdout != ""

    - name: Display kube-proxy logs
      debug:
        msg: "{{ kube_proxy_logs.stdout_lines }}"
      when: kube_proxy_pod.stdout != ""

    - name: Get kube-proxy events
      shell: kubectl --kubeconfig={{ kubeconfig }} get events -n kube-system --field-selector involvedObject.name={{ kube_proxy_pod.stdout }} --sort-by='.lastTimestamp' | tail -10 2>&1 || echo "Could not get events"
      register: kube_proxy_events
      changed_when: false
      failed_when: false
      when: kube_proxy_pod.stdout != ""

    - name: Display kube-proxy events
      debug:
        msg: "{{ kube_proxy_events.stdout_lines }}"
      when: kube_proxy_pod.stdout != ""

    - name: Check node status
      shell: kubectl --kubeconfig={{ kubeconfig }} get nodes -o wide
      register: node_status
      changed_when: false
      failed_when: false

    - name: Display node status
      debug:
        msg: "{{ node_status.stdout_lines }}"

    - name: Check kubelet status
      shell: systemctl status kubelet --no-pager | head -20
      register: kubelet_status
      changed_when: false
      failed_when: false

    - name: Display kubelet status
      debug:
        msg: "{{ kubelet_status.stdout_lines }}"

    - name: Check network configuration
      shell: |
        echo "=== IP Forwarding ==="
        sysctl net.ipv4.ip_forward
        echo "=== Bridge Modules ==="
        lsmod | grep -E 'br_netfilter|bridge' || echo "Bridge modules not loaded"
        echo "=== Sysctl Config ==="
        cat /etc/sysctl.d/99-kubernetes.conf 2>/dev/null || echo "Sysctl config not found"
      register: network_config
      changed_when: false
      failed_when: false

    - name: Display network configuration
      debug:
        msg: "{{ network_config.stdout_lines }}"

    - name: Check if CNI needs to be installed
      fail:
        msg: |
          ==========================================
          DIAGNOSIS: CNI plugin is not installed or not ready
          ==========================================
          CNI ready pods: {{ cni_ready_count.stdout }}
          Action required: Install CNI plugin
          ==========================================
      when: cni_ready_count.stdout | int == 0

    - name: Install CNI if missing (Flannel)
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      register: cni_install
      retries: 3
      delay: 10
      when: 
        - cni_ready_count.stdout | int == 0
        - cni_plugin | default('flannel') == "flannel"
      ignore_errors: yes

    - name: Wait for CNI to be ready
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod -l app=flannel -n kube-flannel --timeout=300s || \
        kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod -l k8s-app=calico-node -n kube-system --timeout=300s || true
      register: cni_wait
      retries: 10
      delay: 10
      until: cni_wait.rc == 0
      changed_when: false
      when: cni_install is defined or cni_ready_count.stdout | int == 0

    - name: Restart kube-proxy after CNI is ready
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} delete pod -n kube-system -l k8s-app=kube-proxy
        sleep 10
      when: cni_wait.rc == 0 | default(false)

    - name: Wait for kube-proxy to restart
      shell: kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod -l k8s-app=kube-proxy -n kube-system --timeout=180s
      register: kube_proxy_wait
      retries: 6
      delay: 10
      until: kube_proxy_wait.rc == 0
      changed_when: false
      ignore_errors: yes
      when: cni_wait.rc == 0 | default(false)

    - name: Final kube-proxy status
      shell: kubectl --kubeconfig={{ kubeconfig }} get pods -n kube-system -l k8s-app=kube-proxy
      register: final_status
      changed_when: false
      failed_when: false

    - name: Display final status
      debug:
        msg: |
          ==========================================
          Final kube-proxy Status:
          {{ final_status.stdout }}
          ==========================================
          If still failing, check logs:
          kubectl --kubeconfig={{ kubeconfig }} logs -n kube-system -l k8s-app=kube-proxy --tail=100
          ==========================================

