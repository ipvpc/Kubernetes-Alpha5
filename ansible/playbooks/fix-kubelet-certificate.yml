---
# Playbook: Fix Kubelet Certificate Verification Issues
# This playbook fixes TLS certificate verification errors for kubelet on all nodes
# Usage: ansible-playbook playbooks/fix-kubelet-certificate.yml -i inventory-devops.yml

- name: Fix kubelet certificate issues on all nodes
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Get master node IP
      set_fact:
        master_ip: "{{ hostvars[groups['control_plane'][0]]['ansible_host'] }}"

    - name: Check if kubelet config exists
      stat:
        path: /var/lib/kubelet/config.yaml
      register: kubelet_config_exists

    - name: Check if kubelet kubeconfig exists
      stat:
        path: /var/lib/kubelet/kubeconfig
      register: kubelet_kubeconfig_exists

    - name: Check if bootstrap kubeconfig exists
      stat:
        path: /var/lib/kubelet/bootstrap-kubeconfig
      register: bootstrap_kubeconfig_exists

    - name: Check current kubelet kubeconfig server
      shell: |
        if [ -f /var/lib/kubelet/kubeconfig ]; then
          grep -E '^\s*server:' /var/lib/kubelet/kubeconfig | head -1
        elif [ -f /var/lib/kubelet/bootstrap-kubeconfig ]; then
          grep -E '^\s*server:' /var/lib/kubelet/bootstrap-kubeconfig | head -1
        else
          echo "No kubelet kubeconfig found"
        fi
      register: kubelet_server
      changed_when: false
      failed_when: false

    - name: Display current kubelet server
      debug:
        msg: "Current kubelet kubeconfig server: {{ kubelet_server.stdout }}"

    - name: Check if admin.conf exists on master
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_exists
      when: inventory_hostname in groups['control_plane']

    - name: Copy admin.conf to kubelet kubeconfig on master
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /var/lib/kubelet/kubeconfig
        remote_src: true
        mode: '0644'
      when:
        - inventory_hostname in groups['control_plane']
        - admin_conf_exists.stat.exists

    - name: Update kubelet kubeconfig server endpoint on master
      replace:
        path: /var/lib/kubelet/kubeconfig
        regexp: '^\s*server:\s*https://127\.0\.0\.1:6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when:
        - inventory_hostname in groups['control_plane']
        - kubelet_kubeconfig_exists.stat.exists or admin_conf_exists.stat.exists

    - name: Update kubelet kubeconfig server endpoint from localhost on master
      replace:
        path: /var/lib/kubelet/kubeconfig
        regexp: '^\s*server:\s*https://localhost:6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when:
        - inventory_hostname in groups['control_plane']
        - kubelet_kubeconfig_exists.stat.exists or admin_conf_exists.stat.exists

    - name: For worker nodes, check if we can get kubeconfig from master
      shell: |
        # Try to get kubeconfig from master node
        if [ -f /etc/kubernetes/kubelet.conf ]; then
          # kubelet.conf should already be correct after joining
          echo "kubelet.conf exists"
        else
          echo "kubelet.conf not found"
        fi
      register: worker_kubelet_check
      changed_when: false
      failed_when: false
      when: inventory_hostname in groups['workers']

    - name: Check kubelet.conf on worker nodes
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf_exists
      when: inventory_hostname in groups['workers']

    - name: Display worker kubelet status
      debug:
        msg: "Worker kubelet.conf exists: {{ kubelet_conf_exists.stat.exists | default(false) }}"
      when: inventory_hostname in groups['workers']

    - name: Restart kubelet to apply changes
      systemd:
        name: kubelet
        state: restarted
      ignore_errors: yes

    - name: Wait for kubelet to restart
      pause:
        seconds: 10

    - name: Check kubelet status
      shell: systemctl status kubelet --no-pager | head -20
      register: kubelet_status
      changed_when: false
      failed_when: false

    - name: Display kubelet status
      debug:
        msg: "{{ kubelet_status.stdout_lines }}"
      when: kubelet_status is defined

    - name: Check kubelet logs for certificate errors
      shell: journalctl -u kubelet --no-pager -n 50 | grep -i "certificate\|tls" | tail -10 || echo "No certificate errors in recent logs"
      register: kubelet_cert_logs
      changed_when: false
      failed_when: false

    - name: Display kubelet certificate error logs
      debug:
        msg: "{{ kubelet_cert_logs.stdout_lines }}"
      when: kubelet_cert_logs is defined

    - name: Display fix completion message
      debug:
        msg: |
          ==========================================
          Kubelet Certificate Fix Summary
          ==========================================
          Node: {{ inventory_hostname }}
          Master IP: {{ master_ip }}
          Kubelet config exists: {{ kubelet_config_exists.stat.exists }}
          Kubelet kubeconfig exists: {{ kubelet_kubeconfig_exists.stat.exists | default(false) }}
          Kubelet restarted: Yes
          ==========================================
          If errors persist:
          1. Check API server certificate includes master IP in SANs
          2. Verify kubelet can reach master on port 6443
          3. Check kubelet logs: journalctl -u kubelet -f
          4. On master, verify: kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes
          ==========================================

