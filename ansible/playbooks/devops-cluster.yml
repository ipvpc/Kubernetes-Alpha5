---
# Ansible Playbook: Create DevOps Kubernetes Cluster
# This playbook creates a Kubernetes cluster named "devops"
# Usage: ansible-playbook playbooks/devops-cluster.yml -i ../inventory-devops.yml

- name: Pre-installation information
  hosts: all
  become: false
  gather_facts: false
  
  vars:
    cluster_name: "devops"
  
  tasks:
    - name: Display cluster information
      debug:
        msg: |
          ==========================================
          Creating Kubernetes Cluster: {{ cluster_name }}
          Install Method: {{ install_method | default('kubeadm') }}
          ==========================================
          Control Plane Nodes: {{ groups['control_plane'] | default([]) | length }}
          Worker Nodes: {{ groups['workers'] | default([]) | length }}
          ==========================================

- import_playbook: kubeadm-install.yml
  when: install_method | default('kubeadm') == "kubeadm"

- import_playbook: k3s-install.yml
  when: install_method | default('kubeadm') == "k3s"

- name: Post-installation tasks for DevOps cluster
  hosts: control_plane[0]
  become: true
  gather_facts: false
  
  vars:
    cluster_name: "devops"
    setup_network_isolation: false
  
  tasks:
    - name: Check if admin.conf exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_check

    - name: Check if copied kubeconfig exists
      stat:
        path: /root/.kube/config
      register: copied_kubeconfig_check

    - name: Set kubeconfig path
      set_fact:
        kubeconfig: "{{ '/etc/kubernetes/admin.conf' if admin_conf_check.stat.exists else '/root/.kube/config' }}"
      when: admin_conf_check.stat.exists or copied_kubeconfig_check.stat.exists

    - name: Check if kubeconfig exists
      stat:
        path: "{{ kubeconfig }}"
      register: kubeconfig_check
      when: admin_conf_check.stat.exists or copied_kubeconfig_check.stat.exists

    - name: Set cluster context name
      shell: |
        kubectl config --kubeconfig={{ kubeconfig }} rename-context default {{ cluster_name }} 2>/dev/null || \
        kubectl config --kubeconfig={{ kubeconfig }} set-context {{ cluster_name }} --cluster=kubernetes --user=kubernetes-admin 2>/dev/null || true
      changed_when: false
      ignore_errors: yes
      when: kubeconfig_check.stat.exists

    - name: Verify cluster is ready
      shell: kubectl --kubeconfig={{ kubeconfig }} get nodes -o wide
      register: cluster_status
      changed_when: false
      ignore_errors: yes
      when: kubeconfig_check.stat.exists

    - name: Display cluster status
      debug:
        msg: "{{ cluster_status.stdout_lines | default(['Cluster status check failed']) }}"
      when: cluster_status is defined

    - name: Wait for Calico to be ready before setting up network isolation
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod -l k8s-app=calico-node -n kube-system --timeout=300s
      register: calico_wait
      retries: 10
      delay: 10
      until: calico_wait.rc == 0
      changed_when: false
      ignore_errors: yes
      when: 
        - kubeconfig_check.stat.exists
        - cni_plugin | default('calico') == "calico"
        - setup_network_isolation | bool

    - name: Setup network isolation (default deny-all)
      shell: |
        cat <<EOF | kubectl --kubeconfig={{ kubeconfig }} apply -f -
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: default-deny-all
          namespace: default
        spec:
          podSelector: {}
          policyTypes:
          - Ingress
          - Egress
        EOF
      register: default_policy
      changed_when: default_policy.rc == 0
      when: 
        - kubeconfig_check.stat.exists
        - setup_network_isolation | bool
        - calico_wait is defined
        - (calico_wait.rc | default(999)) == 0

    - name: Setup allow DNS network policy
      shell: |
        kubectl --kubeconfig={{ kubeconfig }} label namespace kube-system name=kube-system --overwrite || true
        cat <<EOF | kubectl --kubeconfig={{ kubeconfig }} apply -f -
        apiVersion: networking.k8s.io/v1
        kind: NetworkPolicy
        metadata:
          name: allow-dns
          namespace: default
        spec:
          podSelector: {}
          policyTypes:
          - Egress
          egress:
          - to:
            - namespaceSelector:
                matchLabels:
                  name: kube-system
            ports:
            - protocol: UDP
              port: 53
            - protocol: TCP
              port: 53
        EOF
      register: dns_policy
      changed_when: dns_policy.rc == 0
      when: 
        - kubeconfig_check.stat.exists
        - setup_network_isolation | bool
        - calico_wait is defined
        - (calico_wait.rc | default(999)) == 0

    - name: Display network policies created
      shell: kubectl --kubeconfig={{ kubeconfig }} get networkpolicies -A
      register: np_status
      changed_when: false
      failed_when: false
      when: 
        - kubeconfig_check.stat.exists
        - setup_network_isolation | bool

    - name: Display cluster information
      debug:
        msg: |
          ==========================================
          DevOps Kubernetes Cluster Created!
          Cluster Name: {{ cluster_name }}
          CNI Plugin: {{ cni_plugin | default('calico') }}
          Network Isolation: {{ 'Enabled' if setup_network_isolation else 'Disabled' }}
          ==========================================
          To access the cluster:
          1. Copy kubeconfig from master node:
             scp {{ ansible_user | default('root') }}@{{ hostvars[groups['control_plane'][0]]['ansible_host'] }}:/root/.kube/config ~/.kube/config-{{ cluster_name }}
          2. Set KUBECONFIG:
             export KUBECONFIG=~/.kube/config-{{ cluster_name }}
          3. Verify cluster:
             kubectl get nodes
          {% if setup_network_isolation %}
          
          Network Isolation:
          - Default deny-all policy is active
          - DNS is allowed
          - Pods are isolated by default
          - To expose services, use NodePort/LoadBalancer/Ingress
          - See: ansible/NETWORK_ISOLATION_GUIDE.md
          {% endif %}
          ==========================================

