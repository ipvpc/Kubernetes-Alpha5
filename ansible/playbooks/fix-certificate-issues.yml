---
# Playbook: Fix All Certificate Issues
# This playbook fixes both kubectl and kubelet certificate verification errors
# Usage: ansible-playbook playbooks/fix-certificate-issues.yml -i inventory-devops.yml

- name: Fix kubectl and kubelet certificate issues
  hosts: all
  become: true
  gather_facts: false
  
  tasks:
    - name: Get master node IP
      set_fact:
        master_ip: "{{ hostvars[groups['control_plane'][0]]['ansible_host'] }}"

    - name: Check if admin.conf exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_exists
      failed_when: false
      changed_when: false

    - name: Check if copied kubeconfig exists
      stat:
        path: /root/.kube/config
      register: copied_kubeconfig_exists
      failed_when: false
      changed_when: false

    # Fix kubectl kubeconfig on master
    - name: Copy admin.conf to .kube/config on master
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true
        mode: '0644'
      when: 
        - inventory_hostname in groups['control_plane']
        - admin_conf_exists is defined
        - (admin_conf_exists.stat.exists | default(false))

    - name: Update kubectl kubeconfig server endpoint
      replace:
        path: /root/.kube/config
        regexp: '^\s*server:\s*https://(127\.0\.0\.1|localhost):6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when: 
        - inventory_hostname in groups['control_plane']
        - copied_kubeconfig_exists is defined
        - (copied_kubeconfig_exists.stat.exists | default(false)) or (admin_conf_exists is defined and (admin_conf_exists.stat.exists | default(false)))

    # Fix kubelet kubeconfig on all nodes
    - name: Check if kubelet kubeconfig exists
      stat:
        path: /var/lib/kubelet/kubeconfig
      register: kubelet_kubeconfig_exists
      failed_when: false
      changed_when: false

    - name: Copy admin.conf to kubelet kubeconfig on master
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /var/lib/kubelet/kubeconfig
        remote_src: true
        mode: '0644'
      when:
        - inventory_hostname in groups['control_plane']
        - admin_conf_exists is defined
        - (admin_conf_exists.stat.exists | default(false))

    - name: Update kubelet kubeconfig server endpoint on master
      replace:
        path: /var/lib/kubelet/kubeconfig
        regexp: '^\s*server:\s*https://(127\.0\.0\.1|localhost):6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when:
        - inventory_hostname in groups['control_plane']
        - kubelet_kubeconfig_exists is defined
        - (kubelet_kubeconfig_exists.stat.exists | default(false))

    - name: Restart kubelet to apply changes
      systemd:
        name: kubelet
        state: restarted
      ignore_errors: yes

    - name: Wait for kubelet to restart
      pause:
        seconds: 10

    - name: Test kubectl access on master
      shell: kubectl --kubeconfig=/root/.kube/config cluster-info 2>&1
      register: kubectl_test
      changed_when: false
      failed_when: false
      when: inventory_hostname in groups['control_plane']

    - name: Display fix status
      debug:
        msg: |
          ==========================================
          Certificate Fix Summary
          ==========================================
          Node: {{ inventory_hostname }}
          Master IP: {{ master_ip }}
          {% if inventory_hostname in groups['control_plane'] %}
          Kubectl test: {{ 'SUCCESS' if (kubectl_test.rc | default(999)) == 0 else 'FAILED' }}
          {% endif %}
          Kubelet restarted: Yes
          ==========================================

