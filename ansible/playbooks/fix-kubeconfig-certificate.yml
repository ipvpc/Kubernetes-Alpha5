---
# Fix kubeconfig Certificate Issues
# This playbook fixes TLS certificate verification errors in kubeconfig
# Usage: ansible-playbook playbooks/fix-kubeconfig-certificate.yml -i inventory-devops.yml

- name: Fix kubeconfig Certificate Issues
  hosts: control_plane[0]
  become: true
  gather_facts: false
  
  tasks:
    - name: Get master node IP
      set_fact:
        master_ip: "{{ hostvars[groups['control_plane'][0]]['ansible_host'] }}"

    - name: Check if admin.conf exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_exists

    - name: Check if copied kubeconfig exists
      stat:
        path: /root/.kube/config
      register: copied_kubeconfig_exists

    - name: Display current kubeconfig server
      shell: |
        if [ -f /root/.kube/config ]; then
          grep -E '^\s*server:' /root/.kube/config | head -1
        elif [ -f /etc/kubernetes/admin.conf ]; then
          grep -E '^\s*server:' /etc/kubernetes/admin.conf | head -1
        else
          echo "No kubeconfig found"
        fi
      register: current_server
      changed_when: false
      failed_when: false

    - name: Display current server
      debug:
        msg: "Current kubeconfig server: {{ current_server.stdout }}"

    - name: Verify admin.conf works
      shell: kubectl --kubeconfig=/etc/kubernetes/admin.conf cluster-info 2>&1
      register: admin_conf_test
      changed_when: false
      failed_when: false
      when: admin_conf_exists.stat.exists

    - name: Display admin.conf test result
      debug:
        msg: "{{ admin_conf_test.stdout_lines }}"
      when: admin_conf_test is defined

    - name: Copy admin.conf to .kube/config if it works
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true
        mode: '0644'
      when: 
        - admin_conf_exists.stat.exists
        - admin_conf_test.rc == 0

    - name: Copy admin.conf to .kube/config even if test failed (certificate might be correct)
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true
        mode: '0644'
      when: 
        - admin_conf_exists.stat.exists
        - admin_conf_test.rc != 0
        - not copied_kubeconfig_exists.stat.exists

    - name: Update kubeconfig server endpoint to master IP (127.0.0.1)
      replace:
        path: /root/.kube/config
        regexp: '^\s*server:\s*https://127\.0\.0\.1:6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when: copied_kubeconfig_exists.stat.exists or admin_conf_exists.stat.exists

    - name: Update kubeconfig server endpoint from localhost
      replace:
        path: /root/.kube/config
        regexp: '^\s*server:\s*https://localhost:6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when: copied_kubeconfig_exists.stat.exists or admin_conf_exists.stat.exists

    - name: Update kubeconfig server endpoint from any IP mismatch
      replace:
        path: /root/.kube/config
        regexp: '^\s*server:\s*https://[^:]+:6443'
        replace: '    server: https://{{ master_ip }}:6443'
      when: 
        - copied_kubeconfig_exists.stat.exists or admin_conf_exists.stat.exists
        - "'{{ master_ip }}' not in kubeconfig_server.stdout | default('')"

    - name: Verify certificate in kubeconfig
      shell: |
        kubectl --kubeconfig=/root/.kube/config config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d | openssl x509 -text -noout 2>/dev/null | grep -E 'Subject:|Issuer:' || echo "Certificate check failed"
      register: cert_info
      changed_when: false
      failed_when: false
      when: copied_kubeconfig_exists.stat.exists

    - name: Display certificate info
      debug:
        msg: "{{ cert_info.stdout_lines }}"
      when: cert_info is defined

    - name: Test kubeconfig after fix
      shell: kubectl --kubeconfig=/root/.kube/config cluster-info 2>&1
      register: kubeconfig_test
      changed_when: false
      failed_when: false
      when: copied_kubeconfig_exists.stat.exists

    - name: Display test result
      debug:
        msg: "{{ kubeconfig_test.stdout_lines | default(kubeconfig_test.stdout | default('No output')) }}"
      when: kubeconfig_test is defined

    - name: If still failing, try with insecure skip verify (temporary)
      shell: |
        kubectl --kubeconfig=/root/.kube/config --insecure-skip-tls-verify cluster-info 2>&1
      register: insecure_test
      changed_when: false
      failed_when: false
      when: 
        - copied_kubeconfig_exists.stat.exists
        - kubeconfig_test is defined
        - (kubeconfig_test.rc | default(999)) != 0

    - name: Display insecure test result
      debug:
        msg: "{{ insecure_test.stdout_lines | default(insecure_test.stdout | default('No output')) }}"
      when: insecure_test is defined

    - name: Regenerate kubeconfig if needed
      shell: |
        # Backup old config
        cp /root/.kube/config /root/.kube/config.backup.$(date +%s) || true
        # Copy fresh admin.conf
        cp /etc/kubernetes/admin.conf /root/.kube/config
        # Update server endpoint
        sed -i 's|server: https://127.0.0.1:6443|server: https://{{ master_ip }}:6443|' /root/.kube/config
        sed -i 's|server: https://localhost:6443|server: https://{{ master_ip }}:6443|' /root/.kube/config
      register: regenerate_kubeconfig
      changed_when: (regenerate_kubeconfig.rc | default(999)) == 0
      when: 
        - admin_conf_exists.stat.exists
        - kubeconfig_test is defined
        - (kubeconfig_test.rc | default(999)) != 0
        - insecure_test is defined
        - (insecure_test.rc | default(999)) == 0

    - name: Test regenerated kubeconfig
      shell: kubectl --kubeconfig=/root/.kube/config cluster-info 2>&1
      register: regenerated_test
      changed_when: false
      failed_when: false
      when: 
        - regenerate_kubeconfig is defined
        - (regenerate_kubeconfig.rc | default(999)) == 0

    - name: Display final status
      debug:
        msg: |
          ==========================================
          kubeconfig Certificate Fix Summary
          ==========================================
          Master IP: {{ master_ip }}
          admin.conf exists: {{ admin_conf_exists.stat.exists }}
          Copied kubeconfig exists: {{ copied_kubeconfig_exists.stat.exists }}
          
          {% if kubeconfig_test is defined and (kubeconfig_test.rc | default(999)) == 0 %}
          Status: kubeconfig is working correctly
          {% elif regenerated_test is defined and (regenerated_test.rc | default(999)) == 0 %}
          Status: kubeconfig regenerated and working
          {% elif insecure_test is defined and (insecure_test.rc | default(999)) == 0 %}
          Status: Cluster is accessible but certificate verification failed
          Action: Regenerated kubeconfig from admin.conf
          {% else %}
          Status: Still having issues
          Action: Check API server is running and accessible
          {% endif %}
          
          To test manually:
          kubectl --kubeconfig=/root/.kube/config cluster-info
          kubectl --kubeconfig=/root/.kube/config get nodes
          ==========================================

